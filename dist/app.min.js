angular.module('tasks',['ui.router','kinvey']);
angular.module('login',['ui.router','kinvey']);
angular.module('efforts',['ui.router','kinvey']);

angular.module('tasks')
.controller('tasksController',['$scope','$state','tasks','activeUser',function($scope,$state,tasks,activeUser){
	$scope.tasks = tasks;
	console.log(activeUser);
}])
.controller('addTaskController',['$scope','$state','$kinvey',function($scope,$state,$kinvey){
	$scope.addTask = function(){
		if ($scope.addTaskForm.taskName.$error.required || $scope.addTaskForm.startDate.$error.required || $scope.addTaskForm.endDate.$error.required ) return null;
		var doc = {
			task_name: $scope.task.name,
			start_date: $scope.task.startDate,
			end_date: $scope.task.endDate,
			comments: $scope.task.comments,
		};
		$kinvey.DataStore.save('tasks',doc).then(function(){
			$state.go('root.tasks',{},{reload:true});
		},
		function(err) {
			console.log('There seems to be a problem adding the task!...see the error log below...');
			console.log(err);
		});
	}
}]);

angular.module('tasks')
.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){
	$stateProvider
	.state('root.tasks',{
		url: '/tasks',
		resolve: {
			activeUser: ['$kinvey',function($kinvey){
				return $kinvey.getActiveUser();
			}],
			tasks: ['$kinvey',function($kinvey){
				// var query = new $kinvey.Query();
				// query.equalTo()
				return $kinvey.DataStore.find('tasks',null,{
					relations: {approval: 'task-approval'}
				})
				.then(function(model){
					console.log('fetched records');
					console.log(model);
					return model;
				},function(err){
					console.log('Some error fetching the records!...see log below...');
					console.log(err);
				})
			}]	
		},
		views: {
			'section@root': {
				templateUrl: '/partials/tasks.html',
				controller: 'tasksController'
			}
		}
	})
	.state('root.tasks.addtask',{
		url: '/addtask',
		views: {
			'section@root': {
				templateUrl: '/partials/add-task.html',
				controller: 'addTaskController'
			}
		}
	});
}]);

angular.module('login')
.run(['$kinvey','$state',function($kinvey,$state){
	console.log('login run');
	// TODO: handle kinvey failing to initialize better!
	$kinvey.init({
			appKey: 'kid_Wk8MsXwikg',
			appSecret: '68c9a63e8a4a41b98898796652bfccc5'
	}).then(function(){
		console.log('Kinvey initalized...checking for active user');
		return determineBehaviour($kinvey,$state);
	},function(err){
		console.log('Kinvey could not be initalized (see error log below)...determining behaviour');
		console.log(err);
		return determineBehaviour($kinvey,$state);
	})

	function determineBehaviour($kinvey,$state){
		var activeUser = $kinvey.getActiveUser();
		console.log('determining behaviour')
		if(activeUser!==null){
			console.log('Active user confirmed...redirecting to root state...');
			$state.go('root');
		} else {
			console.log('No active user...redirecting to login page...');
			$state.go('root.login');
		}		
	}
}]);

angular.module('login')
.controller('loginController',['$scope','$state','$kinvey','activeUser',function($scope,$state,$kinvey,activeUser){
	if(activeUser!==null){
		$scope.hasActiveUser = true;
		$scope.username =  activeUser.username;
	} else $scope.hasActiveUser = false;

	$scope.login = function(){
		if ($scope.loginForm.username.$error.required || $scope.loginForm.password.$error.required) return null;

		$kinvey.User.login({
			username: $scope.user.name,
			password: $scope.user.pwd
		}).then(function(res){
			console.log('Successfully logged in!');
			console.log(res);
			$state.reload();
		},function(err){
			console.log('Error logging in!');
			console.log(err);
			$state.reload();
		})
	}

	$scope.logout = function(){
		$kinvey.User.logout().then(function(){
			console.log('Successfully logged out!');
			$state.reload();
		},function(err){
			console.log('Some problem logging out...try again!');
			console.log(err);
			$state.reload();
		})
	}
}]);
angular.module('login')
.config(['$stateProvider',function($stateProvider){
	$stateProvider
	.state('root.login',{
		url: '/login',
		resolve: {
			activeUser: ['$kinvey',function($kinvey){
				return $kinvey.getActiveUser();
			}]
		},
		views: {
			'section@root': {
				templateUrl: '/partials/login.html',
				controller: 'loginController'
			}
		}
	})
}]);

angular.module('efforts')
.controller('effortsController',['$scope','$state',function($scope,$state){

}]);

angular.module('efforts')
.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){
	$stateProvider
	.state('efforts',{
		url: '/efforts',
		resolve: {
			tasks: ['$kinvey',function($kinvey){
				$kinvey.DataStore.find('efforts')
				.then(function(model){
					console.log(model);
					return model;
				},function(err){
					console.log('Error!');
					console.log(err)
				})
			}]
		},
		views: {
			'section@root': {
				templateUrl: '/partials/efforts.html',
				controller: 'effortsController'
			}
		}
	})
}]);

function src_components_component3_js_directive_foo(){
return 'src_components_component3_js_directive_foo';
}

function src_components_component1_js_controllers_foo(){
return 'src_components_component1_js_controllers_foo';
}

function src_components_component2_js_directive_foo(){
return 'src_components_component2_js_directive_foo';
}

function src_components_component2_js_controllers_foo(){
return 'src_components_component2_js_controllers_foo';
}

function src_components_component1_js_directive_foo(){
return 'src_components_component1_js_directive_foo';
}

function src_components_component1_js_controllers_foo(){
return 'src_components_component1_js_controllers_foo';
}

// Defining the app
'use strict';

angular.module('gquotient',['ui.router','kinvey','tasks','login']);

angular.module('gquotient')
.run(function(){
	console.log('main-run');
})
function src_js_directives_foo(){
return 'src_js_directives_foo';
}

function src_js_controllers_foo(){
return 'src_js_controllers_foo';
}

angular.module('gquotient')
.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){
	$urlRouterProvider.otherwise('/');
	$stateProvider.state('root',{
		url: '/',
		views: {
			'body': {
				templateUrl: 'partials/body.html'
			},
			'header@root': {
				templateUrl: 'partials/main-nav.html'
			} 
		}
	});
}])